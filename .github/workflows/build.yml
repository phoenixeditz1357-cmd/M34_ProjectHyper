name: Build HyperOS M34 (Final Fix)
on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'GSI URL'
        required: true
        default: 'https://sourceforge.net/projects/mystic-gsi-updates/files/HyperOS/Hyperos-shennong-15-OS2.0.6.0.VNBCNXM-AB-20241207-MysticGSI.zip/download'

jobs:
  build_final:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: 2. Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip android-sdk-libsparse-utils
          wget https://raw.githubusercontent.com/xpirt/sdat2img/master/sdat2img.py
          chmod +x sdat2img.py

      - name: 3. Download & Prepare GSI
        run: |
          mkdir work
          cd work
          wget -O rom.zip "${{ inputs.gsi_url }}"
          unzip rom.zip
          
          # Find .img file
          GSI_IMG=$(find . -name "*.img" | head -n 1)
          mv "$GSI_IMG" system.img
          
          # Convert to Raw (Mountable)
          if file system.img | grep -q "sparse"; then
            simg2img system.img system_raw.img
            rm system.img
          else
            mv system.img system_raw.img
          fi

      - name: 4. Mount System
        run: |
          cd work
          mkdir -p mnt/system
          # Mount the raw image to the 'mnt/system' folder
          sudo mount -o loop,rw system_raw.img mnt/system

      - name: 5. Inject Overlay (The Fix)
        run: |
          # Download your repo
          git clone https://github.com/phoenixeditz1357-cmd/M34-Gsi-Overlay overlay_temp
          
          # FIND THE APK (Ignores your repo structure, just grabs the file)
          MY_OVERLAY=$(find overlay_temp -name "*.apk" | head -n 1)
          echo "Found Overlay: $MY_OVERLAY"
          
          # DETERMINE CORRECT PATH (Bypassing Symlink Error)
          # In Android 14, /system/product is often a shortcut to /product.
          # We check which one is the REAL folder.
          
          if [ -d "work/mnt/system/product" ]; then
            # Case A: /product exists at root
            TARGET="work/mnt/system/product/overlay"
          elif [ -d "work/mnt/system/system/product" ]; then
            # Case B: /system/product exists
            TARGET="work/mnt/system/system/product/overlay"
          else
            # Case C: Weird structure, force create in system
            TARGET="work/mnt/system/system/product/overlay"
          fi
          
          echo "Injecting into: $TARGET"
          sudo mkdir -p "$TARGET"
          
          # COPY FILE
          sudo cp "$MY_OVERLAY" "$TARGET/treble-overlay-samsung-m34x.apk"
          sudo chmod 644 "$TARGET/treble-overlay-samsung-m34x.apk"
          
          echo "Success!"

      - name: 6. Modify Props (M34 Identity)
        run: |
          PROP="work/mnt/system/system/build.prop"
          
          # Xiaomi 14 Identity (For Features)
          sudo sed -i 's/ro.product.model=.*/ro.product.model=Xiaomi 14/g' $PROP
          sudo sed -i 's/ro.product.device=.*/ro.product.device=houji/g' $PROP
          
          # M34 Fingerprint (For Apps)
          echo "ro.build.fingerprint=samsung/m34x/m34x:14/UP1A.231005.007/M346BXXS3CXE1:user/release-keys" | sudo tee -a $PROP
          
          # VoLTE & Screen Fixes
          echo "persist.dbg.ims_volte_enable=1" | sudo tee -a $PROP
          echo "ro.surface_flinger.max_frame_buffer_acquired_buffers=3" | sudo tee -a $PROP

      - name: 7. Repack & Upload
        run: |
          cd work
          sudo umount mnt/system
          img2simg system_raw.img system_m34.img
          zip -0 -r HyperOS_M34_Final.zip system_m34.img

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS_M34_Final
          path: work/HyperOS_M34_Final.zip
