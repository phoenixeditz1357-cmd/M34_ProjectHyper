name: Build HyperOS for M34
on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'https://sourceforge.net/projects/mystic-gsi-updates/files/HyperOS/Hyperos-duchamp-15-OS2.0.200.3.VNLCNXM-AB-20250416-MysticGSI.zip/download'
        required: true
      overlay_url:
        description: 'https://github.com/phoenixeditz1357-cmd/M34-Gsi-Overlay'
        required: true

jobs:
  build-rom:
    runs-on: ubuntu-latest
    steps:
      # 1. Setup the Computer (Install Tools)
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip xz-utils android-sdk-libsparse-utils
          # Get a tool to modify system images
          wget https://github.com/LonelyFool/lpunpack_and_lpmake/raw/master/make_ext4fs
          chmod +x make_ext4fs
          sudo mv make_ext4fs /usr/local/bin/

      # 2. Download the GSI
      - name: Download HyperOS GSI
        run: |
          echo "Downloading GSI..."
          wget -O system.img.xz "${{ github.event.inputs.gsi_url }}"
          
          # If it is compressed (.xz), extract it. If not, rename it.
          if [[ "${{ github.event.inputs.gsi_url }}" == *.xz ]]; then
            xz -d system.img.xz
          else
            mv system.img.xz system.img
          fi

      # 3. Download the Overlay (Your Link)
      - name: Download Overlay
        run: |
          wget -O overlay.apk "${{ github.event.inputs.overlay_url }}"

      # 4. The Main Event: Injecting Files
      - name: Modify System Image
        run: |
          mkdir -p pmnt
          # Convert to raw image so we can mount it
          simg2img system.img system_raw.img || mv system.img system_raw.img
          
          # Mount the image (Open the box)
          sudo mount -o loop,rw system_raw.img pmnt
          
          # CREATE THE FOLDER if it doesn't exist
          sudo mkdir -p pmnt/product/overlay
          
          # COPY your overlay into the system
          echo "Injecting M34 Overlay..."
          sudo cp overlay.apk pmnt/product/overlay/treble-overlay-samsung-m34x.apk
          
          # Set permissions (Crucial!)
          sudo chmod 644 pmnt/product/overlay/treble-overlay-samsung-m34x.apk
          
          # Unmount (Close the box)
          sudo umount pmnt
          mv system_raw.img system_mod.img

      # 5. Pack it into a Zip for TWRP
      - name: Create Flashable Zip
        run: |
          mkdir -p META-INF/com/google/android
          
          # Write the installation instructions for TWRP
          echo 'ui_print("Installing Modified HyperOS for M34...");' > META-INF/com/google/android/updater-script
          echo 'package_extract_file("system.img", "/dev/block/mapper/system");' >> META-INF/com/google/android/updater-script
          echo 'ui_print("Installation Complete!");' >> META-INF/com/google/android/updater-script
          
          # Rename back to system.img and Zip
          mv system_mod.img system.img
          zip -r HyperOS_M34_Ready.zip system.img META-INF

      # 6. Upload the Result to You
      - name: Upload Zip
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS_M34_Build
          path: HyperOS_M34_Ready.zip
