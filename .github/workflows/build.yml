name: Build HyperOS for M34 (Module Extractor)
on:
  workflow_dispatch:

jobs:
  build-rom:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip xz-utils android-sdk-libsparse-utils e2fsprogs

      - name: Download HyperOS GSI
        run: |
          wget --user-agent="Mozilla/5.0" -O gsi.zip "https://master.dl.sourceforge.net/project/mystic-gsi-updates/HyperOS/Hyperos-duchamp-15-OS2.0.200.3.VNLCNXM-AB-20250416-MysticGSI.zip?viasf=1"
          unzip gsi.zip
          find . -maxdepth 1 -name "*.img" -exec mv {} system.img \;

      - name: Download & Extract Module Zip
        run: |
          echo "Downloading your Repo..."
          # Download your repo as a zip
          wget -O repo.zip "https://github.com/phoenixeditz1357-cmd/M34-Gsi-Overlay/archive/refs/heads/main.zip"
          unzip repo.zip
          
          echo "Hunting for the Module Zip..."
          # Find the zip file you uploaded (ignoring the repo zip itself)
          find . -name "*.zip" ! -name "repo.zip" ! -name "gsi.zip" -exec mv {} module_fix.zip \;
          
          echo "Unzipping the Module..."
          unzip -o module_fix.zip -d module_content
          
          echo "Finding the Overlay APK inside the module..."
          # Look for ANY apk inside the module folder
          find module_content -name "*.apk" -exec mv {} overlay.apk \;
          
          if [ -f overlay.apk ]; then
            echo "SUCCESS: Found Overlay APK inside your module!"
          else
            echo "ERROR: Could not find an APK inside your module zip."
            echo "Listing module content for debug:"
            find module_content
            exit 1
          fi

      - name: Modify System Image
        run: |
          mkdir -p pmnt
          if file system.img | grep -q "Android sparse image"; then
            simg2img system.img system_raw.img
          else
            mv system.img system_raw.img
          fi
          e2fsck -f -y system_raw.img || true
          resize2fs system_raw.img 7G || true
          
          sudo mount -o loop,rw system_raw.img pmnt
          
          sudo mkdir -p pmnt/product/overlay
          sudo cp overlay.apk pmnt/product/overlay/treble-overlay-samsung-m34x.apk
          sudo chmod 644 pmnt/product/overlay/treble-overlay-samsung-m34x.apk
          
          sudo umount pmnt
          mv system_raw.img system.img

      - name: Create Flashable Zip
        run: |
          mkdir -p META-INF/com/google/android
          echo 'ui_print("Installing HyperOS M34 (Phoenix)...");' > META-INF/com/google/android/updater-script
          echo 'package_extract_file("system.img", "/dev/block/mapper/system");' >> META-INF/com/google/android/updater-script
          echo 'ui_print("Done!");' >> META-INF/com/google/android/updater-script
          
          zip -r HyperOS_M34_Phoenix.zip system.img META-INF

      - name: Upload Zip
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS_M34_Phoenix
          path: HyperOS_M34_Phoenix.zip
