name: Build HyperOS Duchamp M34 (Gold Edition)
on:
  workflow_dispatch:
    inputs:
      gsi_url:
        description: 'HyperOS Duchamp (A15) URL'
        required: true
        default: 'https://sourceforge.net/projects/mystic-gsi-updates/files/HyperOS/Hyperos-duchamp-15-OS2.0.200.3.VNLCNXM-AB-20250416-MysticGSI.zip/download'
      gapps_url:
        description: 'LiteGApps URL (Direct Download)'
        required: true
        # Using a specific file link derived from your folder to ensure download works
        default: 'https://sourceforge.net/projects/litegapps/files/litegapps/arm64/35/lite/v3.0/LiteGApps-Arm64-35-Lite-v3.0.zip/download'

jobs:
  build_duchamp_gold:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Tools
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          sudo apt-get update
          sudo apt-get install -y git zip unzip android-sdk-libsparse-utils wget tar
          wget https://raw.githubusercontent.com/xpirt/sdat2img/master/sdat2img.py
          chmod +x sdat2img.py

      - name: 2. Download ROM & GApps
        run: |
          mkdir work
          cd work
          echo "Downloading ROM..."
          wget -O rom.zip "${{ inputs.gsi_url }}"
          unzip rom.zip
          
          echo "Downloading GApps..."
          wget -O gapps.zip "${{ inputs.gapps_url }}"
          mkdir gapps_extract
          unzip gapps.zip -d gapps_extract
          
          # Prepare System Image
          FOUND_IMG=$(find . -maxdepth 1 -name "*.img" | head -n 1)
          if [ "$FOUND_IMG" != "./system.img" ] && [ "$FOUND_IMG" != "system.img" ]; then mv "$FOUND_IMG" system.img; fi
          
          if file system.img | grep -q "sparse"; then
            simg2img system.img system_raw.img
            rm system.img
          else
            mv system.img system_raw.img
          fi

      - name: 3. Mount System
        run: |
          cd work
          mkdir -p mnt/system
          sudo mount -o loop,rw system_raw.img mnt/system

      - name: 4. Debloat (Careful Mode)
        run: |
          S_DIR="work/mnt/system/system"
          # ONLY removing useless AI bloat. NOT touching Treble settings.
          sudo rm -rf $S_DIR/app/MSA
          sudo rm -rf $S_DIR/app/AnalyticsCore
          sudo rm -rf $S_DIR/app/AiAsstVision
          sudo rm -rf $S_DIR/priv-app/Updater
          # User requested NO Treble app deletion, so we skip that.

      - name: 5. Install LiteGApps (Android 15)
        run: |
          echo "Injecting GApps..."
          S_DIR="work/mnt/system/system"
          
          # LiteGApps extraction logic
          if [ -d "work/gapps_extract/system" ]; then
             sudo cp -r work/gapps_extract/system/* $S_DIR/
          else
             # Fallback if zip structure is flat
             sudo cp -r work/gapps_extract/* $S_DIR/ 2>/dev/null || true
          fi
          
          # Fix Permissions
          sudo chmod -R 755 $S_DIR/priv-app/Phonesky
          sudo chmod -R 755 $S_DIR/priv-app/GmsCore || true

      - name: 6. Inject M34 Overlay
        run: |
          git clone https://github.com/phoenixeditz1357-cmd/M34-Overlays overlay_repo
          OVERLAY_APK=$(find overlay_repo -name "*.apk" | head -n 1)
          if [ -f "$OVERLAY_APK" ]; then
             TARGET="work/mnt/system/product/overlay"
             if [ ! -d "$TARGET" ]; then TARGET="work/mnt/system/system/product/overlay"; fi
             sudo mkdir -p "$TARGET"
             sudo cp "$OVERLAY_APK" "$TARGET/treble-overlay-samsung-m34x.apk"
             sudo chmod 644 "$TARGET/treble-overlay-samsung-m34x.apk"
             echo "Overlay Injected."
          fi

      - name: 7. Apply Fixes (Storage + AOD + Wake Delay)
        run: |
          PROP="work/mnt/system/system/build.prop"
          
          # --- A. STORAGE FIX (Correct Size Detection) ---
          echo "persist.sys.fuse.passthrough.enable=true" | sudo tee -a $PROP
          echo "ro.storage_manager.enabled=true" | sudo tee -a $PROP
          
          # --- B. WAKE DELAY FIX (Screen On Speed) ---
          # Disables deep idle states for display to speed up wake
          echo "ro.surface_flinger.set_idle_timer_ms=0" | sudo tee -a $PROP
          echo "ro.surface_flinger.set_touch_timer_ms=0" | sudo tee -a $PROP
          echo "ro.surface_flinger.set_display_power_timer_ms=0" | sudo tee -a $PROP
          # Fixes brightness ramp-up delay
          echo "persist.sys.qcom-brightness=1" | sudo tee -a $PROP
          
          # --- C. AOD & LOCKSCREEN EDITOR ---
          # Spoof Xiaomi 14 (Houji) Identity
          echo "ro.product.device=houji" | sudo tee -a $PROP
          echo "ro.miui.ui.version.code=14" | sudo tee -a $PROP
          
          # --- D. M34 HARDWARE MATCHING ---
          echo "persist.dbg.ims_volte_enable=1" | sudo tee -a $PROP
          echo "ro.build.fingerprint=samsung/m34x/m34x:14/UP1A.231005.007/M346BXXS3CXE1:user/release-keys" | sudo tee -a $PROP

      - name: 8. Repack
        run: |
          cd work
          sudo umount mnt/system
          img2simg system_raw.img system_duchamp_gold.img
          zip -0 -r HyperOS_M34_Gold_Edition.zip system_duchamp_gold.img

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS_M34_Gold_Edition
          path: work/HyperOS_M34_Gold_Edition.zip
